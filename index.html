<!DOCTYPE html>
<html lang="en">
<head>
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0"> 
    <title>MEOW HELLO - The Purrfect Place</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;700&family=Chewy&display=swap" rel="stylesheet">
    
    <style>
        html {
            /* Assicura che l'elemento principale prenda tutta l'altezza */
            height: 100%; 
            /* Impedisce lo scorrimento orizzontale superfluo */
            overflow-x: hidden; 
            /* Permette lo scorrimento verticale naturale del documento */
            overflow-y: auto;
        }

        body {
            font-family: 'Poppins', sans-serif;
            margin: 0;
            transition: background-color 0.3s ease;
            /* Garantisce che l'altezza minima sia l'altezza della finestra visibile (viewport) */
            min-height: 100vh; 
            /* Rimosso overflow-x: hidden dal body per evitare conflitti */
        }
        
        #catMaskState, #shopState, #checkoutState, #orderConfirmationState {
            width: 100%;
            min-height: 100%; /* Si adatta all'altezza minima del body */
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
            display: none;
            box-sizing: border-box;
            z-index: 1;
            /* **ATTENZIONE:** Rimosso min-height: 100vh e overflow-y: auto da qui,
                perchÃ© lo scorrimento deve essere gestito dal body/html */
        }

        #catMaskState {
            display: flex;
            opacity: 1;
            background-color: #e0f7fa;
            color: #333;
            flex-direction: column;
            justify-content: flex-start;
            align-items: center;
            padding: 20px 20px 50px 20px;
            z-index: 2;
        }
        
        .visible {
            opacity: 1 !important;
            display: block !important; 
        }
        
        #catMaskState.visible {
            display: flex !important;
        }

        #catMaskState.hidden {
            opacity: 0 !important;
            pointer-events: none;
            position: absolute;
        }
        
        #catMaskState-header {
            width: 100%;
            max-width: 1200px;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            margin-bottom: 30px;
        }

        #catMaskState-title h1 {
            font-family: 'Chewy', cursive;
            font-size: 4.5em;
            color: #ff99aa;
            margin-bottom: -15px;
            text-align: center;
            text-shadow: 2px 2px 0px #fff;
            cursor: default;
        }

        #catMaskState-title p {
            font-family: 'Poppins', sans-serif;
            font-size: 1.2em;
            color: #66bb6a;
            font-weight: bold;
            text-transform: uppercase;
            margin: 0;
            text-align: center;
        }

        .cat-image-container {
            position: relative;
            max-width: 600px;
            width: 90%;
            margin: 30px auto;
            text-align: center;
        }
        
        .cat-hero-image {
            width: 100%;
            height: auto;
            border-radius: 15px;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.15);
            display: block;
        }
        
        /* Products on Cat Mask */
        #maskProducts-container {
            width: 100%;
            max-width: 1000px;
            padding: 20px 0;
            margin-top: 20px;
        }
        
        #maskProducts-container h2 {
            font-family: 'Poppins', sans-serif;
            font-weight: 700;
            color: #333;
            margin-bottom: 25px;
            text-align: center;
            font-size: 2em;
        }

        .mask-product-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 20px;
        }
        
        .mask-product-card {
            background-color: #ffffff;
            border-radius: 15px;
            padding: 15px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
        }
        
        /* *** CORREZIONE IMMAGINI PRODOTTI (Cat Mask) *** */
        .mask-product-card img {
            width: 100%;
            height: 180px; 
            /* Object-fit copre il contenitore, eliminando lo spazio bianco */
            object-fit: cover; 
            border-radius: 10px;
            margin-bottom: 10px;
        }
        
        .mask-product-card h4 {
            color: #555;
            font-size: 0.9em;
        }
        
        .mask-product-card p {
            color: #ff99aa;
            font-weight: bold;
        }
        
        .mask-product-button {
            background-color: #66bb6a;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 8px;
            cursor: pointer;
            width: 100%;
            font-weight: bold;
        }

        .secret-spot {
        position: absolute;
        top: 0px;
        right: 0px;
        width: 5px; 
        height: 5px;
        cursor: pointer;
        z-index: 10;
        opacity: 0; 
        }

        /* --- SHOP MASK (Neutral/Original Look) --- */
        #shopState {
            background-color: #f4f4f4;
            color: #333;
            padding: 30px;
            max-width: 1000px;
            margin: 0 auto;
        }
        
        #shopState h1 {
            font-size: 2.5em;
            color: #1a1a1a;
            text-transform: uppercase;
        }

        .shop-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            margin-bottom: 30px;
            border-bottom: 2px solid #ccc;
        }

        .cart-icon-container {
            position: relative;
            cursor: pointer;
            padding: 8px 12px;
            background-color: #e0e0e0;
            border-radius: 5px;
            width: 40px;
            height: 40px;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .cart-icon {
            font-size: 1.5em;
        }

        #cart-count {
            position: absolute;
            top: -5px;
            right: -5px;
            background-color: #cc0000;
            color: white;
            padding: 2px 6px;
            border-radius: 50%;
            font-size: 0.8em;
            line-height: 1;
        }
        
        .product-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 25px;
        }

        .product-card {
            background-color: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
            border: 1px solid #ddd;
        }

        /* *** CORREZIONE IMMAGINI PRODOTTI (Negozio) *** */
        .product-image {
            width: 100%;
            height: 220px; 
            /* Object-fit copre il contenitore, eliminando lo spazio bianco */
            object-fit: cover; 
            display: block;
        }
        
        .product-info {
            padding: 15px;
            text-align: center;
        }

        .product-title {
            font-size: 1.2em;
            margin: 0 0 5px 0;
            color: #333;
        }

        .product-price {
            font-size: 1.5em;
            font-weight: bold;
            color: #007bff;
            margin: 0 0 15px 0;
        }

        .quantity-select {
            width: 100%;
            padding: 8px;
            margin-bottom: 15px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }

        .add-to-cart-button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            width: 100%;
            font-size: 1em;
            transition: background-color 0.2s;
        }

        .add-to-cart-button:hover {
            background-color: #0056b3;
        }

        /* MODAL STYLES */
        #cartModal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-content {
            background-color: white;
            padding: 30px;
            border-radius: 10px;
            width: 90%;
            max-width: 450px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        .cart-item {
            display: flex;
            justify-content: space-between;
            align-items: center; /* Allineamento verticale per il pulsante rimuovi */
            padding: 8px 0;
            border-bottom: 1px solid #eee;
        }
        
        .cart-item button { /* Stile per il pulsante Rimuovi */
            background: #ff5252;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            margin-left: 10px;
            font-size: 0.8em;
        }

        .checkout-button {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 4px;
            background-color: #28a745;
            color: white;
            font-size: 1.1em;
            cursor: pointer;
            margin-top: 20px;
        }
        .checkout-button:hover {
            background-color: #1e7e34;
        }

        /* --- CHECKOUT/CONFIRMATION STATES --- */
        #checkoutState, #orderConfirmationState {
            background-color: #f4f4f4;
            padding: 30px 0;
            display: flex;
            justify-content: center;
            /* Rimosso overflow-y: auto e min-height: 100vh come correzione scroll */
        }

        .checkout-container {
            margin: 20px auto; 
            display: flex;
            max-width: 1000px;
            width: 90%; 
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        /* *** NUOVA DIVISIONE LAYOUT CHECKOUT (60% / 40%) *** */
        .checkout-left {
            flex: 3; 
            padding: 30px;
            background-color: #f8f9fa;
        }

        .checkout-right {
            flex: 2; 
            background-image: url('https://i.imgur.com/SyCQXvm.gif');
            background-size: cover;
            background-position: center;
        }
        
        .product-summary-box {
            padding: 20px;
            border: 1px solid #ddd;
            background-color: white;
            border-radius: 5px;
            height: 100%; 
            box-sizing: border-box;
        }
        
        .summary-item-wrapper {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 10px;
            padding: 10px 0;
            border-bottom: 1px dashed #eee;
        }
        .summary-item-image {
            width: 80px; /* Ridotto per il riepilogo */
            height: 80px;
            object-fit: cover;
            border-radius: 5px;
        }
        .summary-item-details {
            flex-grow: 1;
        }
        
        .checkout-item-details {
            border-top: 1px solid #eee;
            padding-top: 10px;
            margin-top: 10px;
            line-height: 1.6;
        }

        .submit-order-button, .finish-button {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 4px;
            background-color: #28a745;
            color: white;
            font-size: 1.1em;
            cursor: pointer;
            margin-top: 15px;
        }
        
        .submit-order-button:last-of-type {
            background-color: #ccc;
            color: #333;
        }
        
        .solana-display {
            background-color: #f0f0f0;
            color: #333;
            border: 1px solid #ccc;
            padding: 15px;
            text-align: center;
            font-size: 1.2em;
            font-weight: bold;
            border-radius: 5px;
        }

        
        @media (max-width: 768px) {
            .checkout-container {
                flex-direction: column;
            }
            .checkout-right { 
                height: 200px;
                order: -1; /* Sposta l'immagine sopra il contenuto del form */
            }
            
            /* Rimuovi padding verticale eccessivo sullo stato */
            #checkoutState, #orderConfirmationState {
                padding: 10px 0; 
            }

            /* Riduci il padding interno del contenitore principale per risparmiare spazio */
            .checkout-left {
                padding: 15px; 
            }

            /* Riduci il padding della scatola del riepilogo */
            .product-summary-box {
                padding: 10px; 
            }

            /* Riduci la dimensione dei font nelle intestazioni */
            #catMaskState-title h1 {
                font-size: 3em;
            }
            .shop-header h1 {
                font-size: 1.8em;
            }
        }
    </style>
</head>
<body>
    
    <div class="mask-state" id="catMaskState">
        <div id="catMaskState-header">
            <div id="catMaskState-title">
                <h1>MEOW HELLO</h1>
                <p>The Purrfect Place for Cats & Humans</p>
            </div>
        </div>

        <div class="cat-image-container">
            <img src="https://images.unsplash.com/photo-1543852786-1cf6624b9987?q=80&w=1887&auto=format&fit=crop&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D" alt="Cute Cat Looking" class="cat-hero-image">
            <div class="secret-spot" id="secretSpot" title="Secret Area"></div>
        </div>

        <div id="maskProducts-container">
            <h2>KITTY TREASURES</h2>
            <div class="mask-product-grid">
                
                <div class="mask-product-card">
                    <img src="https://secure.img1-cg.wfcdn.com/im/53209099/compr-r85/1946/194642674/royal-luxury-cat-bed.jpg" alt="Cat Bed">
                    <h4>Cloud Bed</h4>
                    <p>Â£15.00</p>
                    <button class="mask-product-button" onclick="tryToEnterShop()">Buy Now</button>
                </div>
                <div class="mask-product-card">
                    <img src="https://i5.walmartimages.com/seo/68-Inches-Multi-Level-Big-Cat-Tree-Tall-Multi-Cats-Tower-2-Big-Cat-Condo-Cat-Hair-Brush-Large-Cat-Tree-3-Padded-Plush-Perches-Scratching-Posts_36502d8b-d810-4e79-ae55-ab2cb39bbb37.3bd7edfea35e7957faaaf757195c748c.jpeg?odnHeight=573&odnWidth=573&odnBg=FFFFFF" alt="Scratching Post">
                    <h4>Climbing Tower</h4>
                    <p>Â£45.00</p>
                    <button class="mask-product-button" onclick="tryToEnterShop()">Buy Now</button>
                </div>
                <div class="mask-product-card">
                    <img src="https://s.alicdn.com/@sc04/kf/Hf18ace0651e24d9395b73c429d962f12L.jpg_300x300.jpg" alt="Food Bowl">
                    <h4>Smart Food Bowl</h4>
                    <p>Â£22.50</p>
                    <button class="mask-product-button" onclick="tryToEnterShop()">Buy Now</button>
                </div>
                <div class="mask-product-card">
                    <img src="https://cdn.shopify.com/s/files/1/2977/2416/products/kit-cat-dry-cat-food-chicken-cuisine_1_3.jpg?v=1571711393" alt="Dry Food">
                    <h4>Salmon Kibble Bag</h4>
                    <p>Â£18.00</p>
                    <button class="mask-product-button" onclick="tryToEnterShop()">Buy Now</button>
                </div>
                <div class="mask-product-card">
                    <img src="https://s.alicdn.com/@sc04/kf/H5899dcc2d46248e4940491160eadf67a0.jpg_300x300.jpg" alt="Cat Treats">
                    <h4>Protein Treats</h4>
                    <p>Â£10.50</p>
                    <button class="mask-product-button" onclick="tryToEnterShop()">Buy Now</button>
                </div>
                <div class="mask-product-card">
                    <img src="https://m.media-amazon.com/images/I/719mzqZYD0L._AC_SX569_.jpg" alt="Carrier">
                    <h4>Travel Carrier</h4>
                    <p>Â£60.00</p>
                    <button class="mask-product-button" onclick="tryToEnterShop()">Buy Now</button>
                </div>
                <div class="mask-product-card">
                    <img src="https://fancyadd.com/cdn/shop/products/13_b7ae2e96-a4c9-479c-adde-afe19057956d.jpg?v=1709911586&width=1445" alt="Luxury House">
                    <h4>Cat House</h4>
                    <p>Â£75.00</p>
                    <button class="mask-product-button" onclick="tryToEnterShop()">Buy Now</button>
                </div>
                <div class="mask-product-card">
                    <img src="https://s.alicdn.com/@sc04/kf/Hb38414939d0d4f5d86fd3797b5612841a.jpg_300x300.jpg" alt="Brush">
                    <h4>De-Shedding Brush</h4>
                    <p>Â£25.00</p>
                    <button class="mask-product-button" onclick="tryToEnterShop()">Buy Now</button>
                </div>
                <div class="mask-product-card">
                    <img src="https://m.media-amazon.com/images/I/51jIv6GPAeL._AC_.jpg" alt="Litter">
                    <h4>Premium Litter Sand</h4>
                    <p>Â£99.00</p>
                    <button class="mask-product-button" onclick="tryToEnterShop()">Buy Now</button>
                </div>
                <div class="mask-product-card">
                    <img src="https://ae-pic-a1.aliexpress-media.com/kf/S1dbbab5c924c4d298ca8186aae2a8ba0h.jpg_960x960q75.jpg_.avif" alt="Clothes">
                    <h4>Winter Coat</h4>
                    <p>Â£30.00</p>
                    <button class="mask-product-button" onclick="tryToEnterShop()">Buy Now</button>
                </div>
            </div>
        </div>
    </div>
    
    <div class="shop-state" id="shopState">
        <div class="shop-header">
            <h1>DIRECT NOTES PURCHASE</h1>
            <div class="cart-icon-container" onclick="toggleCart()">
                <div class="cart-icon">ðŸ›’</div>
                <span id="cart-count">0</span>
            </div>
        </div>
        
        <div class="product-grid">
            <div class="product-card" data-id="1" data-name="NOTESLAB Â£100 LNotes" data-price="35.0" data-img="https://i.imgur.com/SAmyk1R.jpeg">
                <img src="https://i.imgur.com/SAmyk1R.jpeg" alt="Â£100 Note Stack" class="product-image">
                <div class="product-info">
                    <h2 class="product-title">NOTESLAB Â£100 LNotes</h2>
                    <p class="product-price">Â£35.0</p>
                    <select class="quantity-select" id="qty-1">
                        <option value="1">1</option>
                        <option value="2">2</option>
                        <option value="3">3</option>
                        <option value="4">4</option>
                    </select>
                    <button class="add-to-cart-button" onclick="addToCart(1)">Add to Cart</button>
                </div>
            </div>

            <div class="product-card" data-id="2" data-name="NOTESLAB Â£200 LNotes" data-price="83.0" data-img="https://i.imgur.com/YSGqDKz.png">
                <img src="https://i.imgur.com/YSGqDKz.png" alt="Â£200 Note Stack" class="product-image">
                <div class="product-info">
                    <h2 class="product-title">NOTESLAB Â£200 LNotes</h2>
                    <p class="product-price">Â£83.0</p>
                    <select class="quantity-select" id="qty-2">
                        <option value="1">1</option>
                        <option value="2">2</option>
                        <option value="3">3</option>
                        <option value="4">4</option>
                    </select>
                    <button class="add-to-cart-button" onclick="addToCart(2)">Add to Cart</button>
                </div>
            </div>

            <div class="product-card" data-id="3" data-name="NOTESLAB Â£300 LNotes" data-price="119.0" data-img="https://i.imgur.com/Dhv9Hv1.png">
                <img src="https://i.imgur.com/Dhv9Hv1.png" alt="Â£300 Note Stack" class="product-image">
                <div class="product-info">
                    <h2 class="product-title">NOTESLAB Â£300 LNotes</h2>
                    <p class="product-price">Â£119.0</p>
                    <select class="quantity-select" id="qty-3">
                        <option value="1">1</option>
                        <option value="2">2</option>
                        <option value="3">3</option>
                        <option value="4">4</option>
                    </select>
                    <button class="add-to-cart-button" onclick="addToCart(3)">Add to Cart</button>
                </div>
            </div>

            <div class="product-card" data-id="4" data-name="NOTESLAB Â£500 LNotes" data-price="192.0" data-img="https://i.imgur.com/rretgZm.png">
                <img src="https://i.imgur.com/rretgZm.png" alt="Â£500 Note Stack" class="product-image">
                <div class="product-info">
                    <h2 class="product-title">NOTESLAB Â£500 LNotes</h2>
                    <p class="product-price">Â£192.0</p>
                    <select class="quantity-select" id="qty-4">
                        <option value="1">1</option>
                        <option value="2">2</option>
                        <option value="3">3</option>
                        <option value="4">4</option>
                    </select>
                    <button class="add-to-cart-button" onclick="addToCart(4)">Add to Cart</button>
                </div>
            </div>
        </div>
    </div>
    
    <div id="checkoutState">
        <div class="checkout-container">
            <div class="checkout-left">
                <form id="checkoutForm">
                    <h2>Shipping & Payment</h2>
                    <label for="solanaAddress" style="display: block; margin-bottom: 5px; font-weight: bold;">Solana Address:</label>
                    <input type="text" id="solanaAddress" name="solanaAddress" placeholder="Enter your Solana wallet address" required style="width: 100%; padding: 10px; margin-bottom: 20px; border: 1px solid #ccc; border-radius: 4px;">

                    <h3>Order Summary</h3> <div class="product-summary-box" id="checkout-summary-container"> 
                        <div class="checkout-item-details">
                            </div>
                        <p style="text-align: right; font-weight: bold; margin-top: 15px;">Total: Â£<span id="checkout-summary-total">0.00</span></p>
                    </div>
                    <h3>Payment Details</h3>
                    <div class="solana-display">
                        <p>Total in GBP: Â£<span id="checkout-total-gbp">0.00</span></p>
                        <p>Pay with Solana: <span id="checkout-total-solana">0.00</span> SOL</p>
                    </div>

                    <button type="submit" class="submit-order-button" id="submitOrderButton">Place Order & Get SOL Address</button>
                    <button type="button" class="submit-order-button" onclick="showShop()">Back to Shop</button>
                </form>
            </div>
            
            <div class="checkout-right">
            </div>
        </div>
    </div>

    <div id="orderConfirmationState">
        <div class="checkout-container">
            <div class="checkout-left">
                <div class="product-summary-box" style="padding: 30px;">
                    <h2 style="color: #28a745;">Order Confirmation</h2>
                    
                    <div id="order-details-content">
                        </div>

                    <p style="margin-top: 25px; font-weight: bold; color: #333; border-top: 1px solid #eee; padding-top: 15px;">
                        Send your order number to @e_eeppa.
                    </p>

                    <button class="finish-button" onclick="finalizeOrder()">Back to Shop</button>
                </div>
            </div>
            
            <div class="checkout-right">
            </div>
        </div>
    </div>

    <div id="cartModal" style="display: none;">
        <div class="modal-content">
            <span class="close-button" onclick="toggleCart()" style="float: right; font-size: 2em; line-height: 0.8; cursor: pointer;">&times;</span>
            <h2>Your Cart</h2>
            <div id="cart-items-container">
            </div>
            <p style="text-align: right; font-weight: bold; margin-top: 15px;">Total: Â£<span id="cart-total">0.00</span></p>
            <button class="checkout-button" onclick="checkout()">Proceed to Checkout</button>
        </div>
    </div>
<script>
    const catMaskState = document.getElementById('catMaskState');
    const shopState = document.getElementById('shopState');
    const checkoutState = document.getElementById('checkoutState');
    const orderConfirmationState = document.getElementById('orderConfirmationState');
    const cartModal = document.getElementById('cartModal');
    const cartCount = document.getElementById('cart-count');
    const cartItemsContainer = document.getElementById('cart-items-container');
    const cartTotalDisplay = document.getElementById('cart-total');
    const checkoutTotalGBP = document.getElementById('checkout-total-gbp');
    const checkoutTotalSolana = document.getElementById('checkout-total-solana');
    const checkoutForm = document.getElementById('checkoutForm');
    const orderDetailsContent = document.getElementById('order-details-content');
    const checkoutSummaryContainer = document.getElementById('checkout-summary-container');
    const checkoutSummaryTotal = document.getElementById('checkout-summary-total');

    const secretSpot = document.getElementById('secretSpot'); 

    const TITLE_ELEMENT = document.getElementById('catMaskState-title');
    const SECRET_PASSWORD = "4r5rg6";
    let clickCount = 0;
    let clickTimeout;
    let isShopOpen = true; 

    let cart = [];
    let secretAreaActive = true;
    let lastOrder = null; 
    
    const GLOBAL_STATUS_URL = '/It-s-Just-a-Cat-Shop/shop_status.json';
    const OWNER_SHUTDOWN_KEY = 'YOUR_SECRET_CLOSURE_KEY_12345'; 

    const SOLANA_RATE_PER_GBP = 0.015; 
    
    function convertToSolana(gbpAmount) { 
        return (gbpAmount * SOLANA_RATE_PER_GBP).toFixed(6); 
    } 
    
    function generateOrderNumber() { return 'ORD-' + Math.floor(Math.random() * 90000000 + 10000000); }
    
    function getProductInfo(id) {
        const card = document.querySelector(`.product-card[data-id="${id}"]`);
        if (!card) return null;
        return {
            id: id,
            name: card.getAttribute('data-name'),
            price: parseFloat(card.getAttribute('data-price')),
            img: card.getAttribute('data-img')
        };
    }
    
    function hideAllStates() {
        [catMaskState, shopState, checkoutState, orderConfirmationState].forEach(state => {
            state.classList.remove('visible');
            state.classList.add('hidden');
            setTimeout(() => {
                state.style.display = 'none';
            }, 500); 
        });
        cartModal.style.display = 'none'; 
    }

    function toggleGlobalShopStatus() {
        const action = prompt(`Il negozio Ã¨ attualmente: ${isShopOpen ? 'APERTO' : 'CHIUSO'}.\n\nVuoi cambiare lo stato? Digita:\n- 'close' per chiudere\n- 'open' per aprire\n- Annulla per non fare nulla`);

        if (action && action.toLowerCase() === 'close') {
            isShopOpen = false;
            alert("Blocco Globale ATTIVATO.");
        } else if (action && action.toLowerCase() === 'open') {
            isShopOpen = true;
            alert("Blocco Globale DISATTIVATO.");
        }
        showCatMask(); 
    }

    function tryToEnterSecretArea() {
        const input = prompt("Accesso all'Area Gestione (Blocco Globale). Inserisci la password:");
        
        if (input && input === SECRET_PASSWORD) {
            toggleGlobalShopStatus(); 
        } else if (input !== null) {
            alert("Accesso negato.");
        }
    }

    TITLE_ELEMENT.addEventListener('click', function() {
        clickCount++;
        clearTimeout(clickTimeout);

        if (clickCount >= 3) {
            clickCount = 0; 
            tryToEnterSecretArea(); 
        } else {
            clickTimeout = setTimeout(() => {
                clickCount = 0;
            }, 500); 
        }
    });

    function showCatMask() {
        hideAllStates();
        catMaskState.style.display = 'flex'; 
        setTimeout(() => {
            catMaskState.classList.remove('hidden');
            catMaskState.classList.add('visible');
        }, 10);
    }

    function showShop() {
        if (!secretAreaActive) {
            alert("The secure notes access is currently suspended globally.");
            return;
        }

        hideAllStates();
        shopState.style.display = 'block'; 
        window.scrollTo(0, 0); 
        setTimeout(() => {
            shopState.classList.remove('hidden');
            shopState.classList.add('visible');
            renderCart(); 
        }, 10);
    }

    // *** MODIFICATO: NON APRE MAI LO SHOP. L'UNICO ACCESSO Ãˆ SECRET_AREA ***
    window.tryToEnterShop = function() {
        if (!isShopOpen) {
            alert("Attualmente il negozio Ã¨ chiuso per manutenzione. Ci scusiamo per il disagio.");
            return;
        }
        
        // Messaggio che blocca SEMPRE l'accesso diretto dai pulsanti Buy Now
        alert("Oops! This item is currently unavailable. Please check our exclusive selection inside.");
    }
    // *******************************************************************

    function updateCartTotal() {
        const total = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
        cartTotalDisplay.textContent = total.toFixed(2);
        return total;
    }
    
    function renderCheckoutSummary(total) {
        
        checkoutSummaryContainer.innerHTML = '';
        
        const detailsDiv = document.createElement('div');
        detailsDiv.classList.add('checkout-item-details');
        
        if (cart.length === 0) {
            detailsDiv.innerHTML = '<p style="text-align: center; color: #cc0000; font-style: italic;">Your cart is empty.</p>';
        } else {
            cart.forEach(item => {
                const itemWrapper = document.createElement('div');
                itemWrapper.classList.add('summary-item-wrapper');
                
                itemWrapper.innerHTML = `
                    <img src="${item.img}" alt="${item.name}" class="summary-item-image">
                    <div class="summary-item-details">
                        <p style="margin: 0; font-weight: bold; font-size: 0.9em;">${item.name}</p>
                        <p style="margin: 0; font-size: 0.8em; color: #555;">Qty: ${item.quantity} x Â£${item.price.toFixed(2)}</p>
                    </div>
                    <p style="margin: 0; font-weight: bold;">Â£${(item.price * item.quantity).toFixed(2)}</p>
                `;
                detailsDiv.appendChild(itemWrapper);
            });
        }
        
        checkoutSummaryContainer.appendChild(detailsDiv);

        const totalPara = document.createElement('p');
        totalPara.style.cssText = 'text-align: right; font-weight: bold; margin-top: 15px; border-top: 1px solid #ddd; padding-top: 10px;';
        totalPara.innerHTML = `Total: Â£<span id="checkout-summary-total">${total.toFixed(2)}</span>`;
        checkoutSummaryContainer.appendChild(totalPara);
    }

    function renderCart() {
        cartItemsContainer.innerHTML = '';
        cartCount.textContent = cart.length;

        if (cart.length === 0) {
            cartItemsContainer.innerHTML = '<p style="text-align: center; font-style: italic;">Your cart is empty.</p>';
        } else {
            cart.forEach((item, index) => {
                const itemDiv = document.createElement('div');
                itemDiv.classList.add('cart-item');
                itemDiv.innerHTML = `
                    <span>${item.name} (${item.quantity})</span>
                    <div style="display: flex; align-items: center;">
                        <span>Â£${(item.price * item.quantity).toFixed(2)}</span>
                        <button onclick="removeFromCart(${index})">Remove</button>
                    </div>
                `;
                cartItemsContainer.appendChild(itemDiv);
            });
        }
        updateCartTotal();
    }

    window.addToCart = function(id) {
        const info = getProductInfo(id);
        if (!info) return;

        const quantity = parseInt(document.getElementById(`qty-${id}`).value);
        const existingItemIndex = cart.findIndex(item => item.id === id);

        if (existingItemIndex > -1) {
            cart[existingItemIndex].quantity += quantity;
        } else {
            cart.push({ ...info, quantity });
        }

        renderCart();
        alert(`${quantity} x ${info.name} added to cart!`);
    }

    window.removeFromCart = function(index) {
        cart.splice(index, 1);
        renderCart();
        if (cart.length === 0) {
            toggleCart(); 
        }
    }

    window.toggleCart = function() {
        cartModal.style.display = cartModal.style.display === 'flex' ? 'none' : 'flex';
        if (cartModal.style.display === 'flex') {
            renderCart();
        }
    }

    window.checkout = function() {
        if (cart.length === 0) {
            alert("Your cart is empty!");
            return;
        }
        
        hideAllStates();
        checkoutState.style.display = 'flex';
        window.scrollTo(0, 0);

        setTimeout(() => {
            checkoutState.classList.remove('hidden');
            checkoutState.classList.add('visible');
            
            const totalGBP = updateCartTotal();
            const totalSOL = convertToSolana(totalGBP); 

            checkoutTotalGBP.textContent = totalGBP.toFixed(2);
            checkoutTotalSolana.textContent = totalSOL; 
            
            renderCheckoutSummary(totalGBP); 
        }, 10);
    }

    checkoutForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const solanaAddress = document.getElementById('solanaAddress').value;
        const totalGBP = updateCartTotal();
        const totalSOL = convertToSolana(totalGBP); 

        lastOrder = {
            orderNumber: generateOrderNumber(),
            items: cart.map(item => ({
                name: item.name,
                quantity: item.quantity,
                price: item.price,
                total: (item.price * item.quantity).toFixed(2),
                img: item.img
            })),
            solanaAddress: solanaAddress,
            totalGBP: totalGBP.toFixed(2),
            totalSOL: totalSOL,
            timestamp: new Date().toISOString()
        };
        
        showOrderConfirmation(lastOrder);
        
        console.log('Order Placed:', lastOrder); 
    });


    function showOrderConfirmation(order) {
        hideAllStates();
        orderConfirmationState.style.display = 'flex';
        window.scrollTo(0, 0);

        setTimeout(() => {
            orderConfirmationState.classList.remove('hidden');
            orderConfirmationState.classList.add('visible');
            
            let summaryHTML = `
                <p style="margin-bottom: 25px;"><strong>Order ID:</strong> <span style="color: #007bff;">${order.orderNumber}</span></p>
                <p><strong>Payment Address:</strong> <span style="word-break: break-all; font-family: monospace;">${order.solanaAddress}</span></p>
                <p style="font-size: 1.2em; font-weight: bold; color: #ff5722;">Amount to Send: ${order.totalSOL} SOL</p>
                <p style="font-size: 0.9em; color: #555;">(Equivalent to Â£${order.totalGBP})</p>
                
                <h4 style="margin-top: 25px; border-top: 1px solid #eee; padding-top: 15px;">Items Purchased:</h4>
                <div id="confirmation-items-list">
            `;

            order.items.forEach(item => {
                summaryHTML += `
                    <div class="summary-item-wrapper" style="border-bottom: 1px dotted #ccc;">
                        <img src="${item.img}" alt="${item.name}" class="summary-item-image">
                        <div class="summary-item-details">
                            <p style="margin: 0; font-weight: bold; font-size: 0.9em;">${item.name}</p>
                            <p style="margin: 0; font-size: 0.8em; color: #555;">Qty: ${item.quantity}</p>
                        </div>
                            <p style="margin: 0; font-weight: bold;">Â£${item.total}</p>
                    </div>
                `;
            });

            summaryHTML += `</div>`;
            orderDetailsContent.innerHTML = summaryHTML;
        }, 10);
    }

    window.finalizeOrder = function() {
        cart = []; 
        lastOrder = null;
        showShop(); 
    }

    secretSpot.addEventListener('click', async function() {
        if (!secretAreaActive) {
            alert("Shop is already closed.");
            return;
        }
        
        const key = prompt("Enter Closure Key (Secret Notes Access):");
        if (key !== OWNER_SHUTDOWN_KEY) {
            alert("Invalid Key. Access Denied.");
            return;
        }

        const confirmClose = confirm("Are you sure you want to shut down the secure access globally?");
        if (confirmClose) {
            secretAreaActive = false;
            alert("Secure notes access temporarily suspended.");
        }
    });

    window.addEventListener('load', () => {
        showCatMask();
    });
</script>
</body>
</html>
